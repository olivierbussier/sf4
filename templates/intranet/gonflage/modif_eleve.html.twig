{% extends 'base.html.twig' %}

{% block title %}Modif du calendrier de gonflage{% endblock %}

{% block main_page %}

    {% import 'macros/bouton.html.twig' as control %}

    <div class="container">

        {% if seancesUser > 0 %}

            <div class="table-responsive">
                <table class="table">
                    <tr>
                        <th>Date</th>
                        <th>Status</th>
                    </tr>
                    {% for seanceUser in seancesUser %}
                        {% date = seanceUser.date | format('d/m/Y') %}
                        {% if seanceUser.aideGonf1 if User.nom %}
                            {% v = seanceUser.Aide1Validee %}
                        {% else %}
                            {% if seanceUser.aideGonf2 if User.nom %}
                                {% v = seanceUser.Aide2Validee %}
                            {% else %}
                                {% if seanceUser.aideGonf3 if User.nom %}
                                    {% v = seanceUser.Aide3Validee %}
                                {% else %}
                                    {% v = 'X' %}
                                {% endif %}
                            {% endif %}
                        {% endif %}

                        {% if (v is '') or (v = 'NA') %}
                            {% st = 'Inscrit' %}
                        {% endif %}

                        {% if v is 'O' %}
                            {% st = 'Validée' %}
                        {% endif %}

                        {% if v is 'N' %}
                            {% st = 'Absent' %}
                        {% endif %}

                        <tr><td>{{ date }}</td><td>{{ st }}</td></tr>
                    {% endfor %}

                </table>
            </div>
        {% endif %}

        <h3>Modification/Consultation du planning de gonflage pour {{ User.Nom }}</h3>

        <div class="col-xs-12">

            {% if seancesValidees < Config::nb_sess_req and
                  ACTIVITE == 'Prépa N2' or ACTIVITE == 'Prépa N3' or ACTIVITE == 'Prépa N4' %}

                <p>Sur cette page, vous pouvez choisir les créneaux ou vous souhaitez participer. N'oubliez pas que
                    vous devez participer à {{ Config::nb_sess_req }} séances pour valider votre niveau. Les
                    séances sont validées si vous êtes présents. En cas d'impossibilité de venir, il vous incombera
                    de trouver un remplaçant; en effet, sans aide suffisante, le gonflage et la désinfection ne peuvent être réalisés
                    dans de bonnes conditions, et la séance piscine devra donc se faire sans bloc ni détendeur.
                    A cet instant votre participation est la suivante:</p>
                <ul>
                    <li>Vous vous êtes inscrit à {{ nbSeances }} séance{% if nbSeances > 1 %}s{% endif %}</li>
                    <li>
                        {% if nbValidees is 0 %}
                            Aucune séance validée
                        {% else %}
                            {% if nbValidees > 1 %}
                                {{ nbValidees }} séances ont été validées
                            {% else %}
                                1 séance a été validée
                            {% endif %}
                        {% endif %}
                    </li>

                    {% if nbNonvalidees > 1) %}
                        <li class="red">Vous avez manqué {{ nbNonvalidees }} séances</li>
                    {% else %}
                        {% if nbNonvalidees is 1 %}
                            <li class="red">Vous avez manqué 1 séance</li>
                        {% else %}
                            <li>Vous n'avez manqué aucune séance</li>
                        {% endif %}
                    {% endif %}
                </ul>
            {% else %}
                <p>Sur cette page, vous pouvez choisir les créneaux ou vous souhaitez participer.</p>
                <p>Vous avez atteint le nombre de participations requis pour valider votre niveau, ou l'activité que vous
                    avez choisi cette année ne vous demande pas la participation à ces séances. Vous pouvez tout de même
                    vous inscrire afin de participer à la vie du club</p>

            {% endif %}
        </div>
{#
        <div class="table-responsive">
            <table class="table">
                <tr>
                    <th>Date</th>
                    <th>Aide 1</th>
                    <th>Aide 2</th>
                    <th>Aide 3</th>
                    <th>Responsable séance</th>
                </tr>

                if (isset($msgerreur) && $msgerreur != "") {
                    ?><tr><td colspan='5'><h2 class="red"><?= $msgerreur ?></h2></td></tr>
                    <?php
                    $msgerreur = "";
                }
                $sql = "SELECT Ref,DATE,SEANCEGONFLAGE,RESPGONFLAGE,".
                    "AIDEGONF1,AIDE1VALIDEE,AIDEGONF2,AIDE2VALIDEE,AIDEGONF3,AIDE3VALIDEE" .
                    " FROM @#@calendrier" .
                    " WHERE ARCHIVE = 'NON' order by DATE";
                $resultat = $db->query($sql);
                    $i = 0;
                    $todaydate = DateTime::createFromFormat("Y-m-d|", date("Y-m-d"));

                    while ($data = $db->nextrow($resultat)) {
                    $aidegonf1      = $data['AIDEGONF1'];
                    $aide1validee   = $data['AIDE1VALIDEE'];
                    $aidegonf2      = $data['AIDEGONF2'];
                    $aide2validee   = $data['AIDE2VALIDEE'];
                    $aidegonf3      = $data['AIDEGONF3'];
                    $aide3validee   = $data['AIDE3VALIDEE'];
                    $respgonflage   = $data['RESPGONFLAGE'];
                    $tempdate       = new DateTime($data['DATE']);
                    if ($todaydate <= $tempdate) {
                    if (($data['SEANCEGONFLAGE'] == 'O')) { ?>
                    <form method="post" action="gon_index_modif_gonf_eleves.php">
                        <input type="hidden" name="Action" value="Update"/>
                        <input type="hidden" name="REFDB" value="<?= $data['Ref'] ?>"/>
                        <input type="hidden" name="DATE" value="<?= $data['DATE'] ?>"/>
                        <tr><td><?= $tempdate->format("d/m/Y") ?></td>
                            <?php
                                    // Cas a gérer :
                                    // 1 - aide == '' et qqsoit aidevalide   -> le créneau est vide, on affiche une checkbox
                            // pour pouvoir prendre le créneau
                            // 2 - aide != '' et aide != currentuser -> le créneau est pris
                            // 3 - aide != '' et aide == currentuser -> le créneau est pris par l'utilisateur, mais on
                            // affiche la checkbox.
                            // ----------------------------------------------------------------------------------------
                            $nomcomplet = $_SESSION['NOM'] . " " . $_SESSION['PRENOM'];
                            if ($aidegonf1 == '') {
                            // Cas 1 : afficher checkbox
                            // -------------------------
                            ?><td><center>
                                    <input type="checkbox" name="aide1" value="O" onchange="submit();">
                                </center></td>
                            <?php
                                    } else {
                                        if ($aidegonf1 == $nomcomplet) {
                                            if (($aide1validee == 'NA') || ($aide1validee == '')) {
                                                ?><td class="green"><center>
                                    <input type="checkbox" name="aide1" value="O" checked  onchange="submit();">
                                    <?= $nomcomplet ?></center>
                            </td>
                            <?php
                                            }
                                        } else { ?>
                            <td class="grey2 center"><?= $aidegonf1 ?></td>
                            <?php
                                        }
                                    }
                                    if ($aidegonf2 == '') {
                                        // Cas 1 : afficher checkbox
                                        // -------------------------
                                        ?><td><center>
                                    <input type="checkbox" name="aide2" value="O" onchange="submit();">
                                </center></td>
                            <?php
                                    } else {
                                        if ($aidegonf2 == $nomcomplet) {
                                            if (($aide2validee == 'NA') || ($aide2validee == '')) {
                                                ?><td class="green"><center>
                                    <input type="checkbox" name="aide2" value="O" checked onchange="submit();">
                                    <?= $nomcomplet ?></center>
                            </td>
                            <?php
                                            }
                                        } else {
                                            ?><td class="grey2 center"><?= $aidegonf2 ?></td>
                            <?php
                                        }
                                    }
                                    if ($aidegonf3 == '') {
                                        // Cas 1 : afficher checkbox
                                        // -------------------------
                                        ?><td><center>
                                    <input type="checkbox" name="aide3" value="O" onchange="submit();">
                                </center></td>
                            <?php
                                    } else {
                                        if ($aidegonf3 == $nomcomplet) {
                                            if (($aide3validee == 'NA') || ($aide3validee == '')) {
                                                ?><td class="green"><center>
                                    <input type="checkbox" name="aide3" value="O" checked onchange="submit();">
                                    <?= $nomcomplet ?></center>
                            </td>
                            <?php
                                            }
                                        } else {
                                            ?><td class="grey2 center"><?= $aidegonf3 ?></center></td>
                            <?php
                                        }
                                    }
                                    ?><td><center><?= $respgonflage ?></center></td></tr>
                    </form>
                    <?php
                        } else {
                            ?><td><?= $tempdate->format("d/m/Y") ?></td>
                    <td class="center grey2" colspan="4">Piscine fermée</td>
                    </tr>
                    <?php
                        }
                    }
                }
                ?>
                </table>
            </div>
        </div>

        <div class="container">
            <a class="btn btn-default btn-block" href="index_intranet.php">
                <span class="glyphicon glyphicon-chevron-left"></span> Revenir à l'accueil de l'intranet.</a>
        </div>
#}
    </div>

{% endblock %}

{% block javascripts_end %}

    {{ parent() }}

{% endblock %}
